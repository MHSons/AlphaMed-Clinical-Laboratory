<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AlphaMed Clinical Laboratory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: { primary: '#0f766e', secondary: '#7c3aed' }
      }}
    }
  </script>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- QRCode + Barcode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode/dist/JsBarcode.all.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .watermark {
      position: fixed;
      bottom: 20px;
      right: 20px;
      opacity: 0.1;
      font-size: 3rem;
      transform: rotate(-30deg);
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <!-- Inline React Code -->
  <script type="text/babel">

    // --- Departments & Tests (Seeded Data) ---
    const departments = [
      {
        name: "Hematology",
        tests: [
          { name: "CBC", params: ["Hemoglobin", "WBC", "Platelets"], ranges: ["13-17 g/dL", "4-11 x10^9/L", "150-450 x10^9/L"] },
          { name: "ESR", params: ["ESR"], ranges: ["0-20 mm/hr"] },
          { name: "Blood Group", params: ["ABO", "Rh"], ranges: ["A/B/AB/O", "+/-"] },
          // ðŸ‘‡ Ø§Ø³ÛŒ Ø·Ø±Ø­ Ù…Ø²ÛŒØ¯ 20 tests add Ú©Ø±ÛŒÚº
        ]
      },
      {
        name: "Biochemistry",
        tests: [
          { name: "LFT", params: ["ALT", "AST", "Bilirubin"], ranges: ["0-40 U/L", "0-40 U/L", "0.1-1.2 mg/dL"] },
          { name: "RFT", params: ["Urea", "Creatinine", "Uric Acid"], ranges: ["15-40 mg/dL", "0.7-1.3 mg/dL", "3-7 mg/dL"] },
          { name: "Glucose", params: ["FBS"], ranges: ["70-110 mg/dL"] },
          // ðŸ‘‡ Ù…Ø²ÛŒØ¯ tests ÚˆØ§Ù„ÛŒÚº
        ]
      },
      // ðŸ‘‡ Ù…Ø²ÛŒØ¯ departments add Ú©Ø±ÛŒÚº
    ];

    // --- Local IndexedDB helper ---
    const DB_NAME = "labdb";
    const STORE = "reports";
    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE)) {
            db.createObjectStore(STORE, { keyPath: "id", autoIncrement: true });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function saveReport(report) {
      const db = await openDB();
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).add(report);
      return tx.complete;
    }
    async function getReports() {
      const db = await openDB();
      return new Promise((resolve) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).getAll();
        req.onsuccess = () => resolve(req.result);
      });
    }

    // --- Main App ---
    function App() {
      const [user, setUser] = React.useState(null);
      const [patients, setPatients] = React.useState([]);
      const [reports, setReports] = React.useState([]);
      const [currentPatient, setCurrentPatient] = React.useState(null);

      React.useEffect(() => {
        getReports().then(setReports);
      }, []);

      const handleLogin = (username, password) => {
        const users = {
          admin: "admin123",
          reception: "recep123",
          tech: "tech123",
          patho: "patho123",
        };
        if (users[username] === password) {
          setUser({ username });
        } else {
          alert("Invalid login");
        }
      };

      const addPatient = (p) => {
        const newPatient = { ...p, id: Date.now() };
        setPatients([...patients, newPatient]);
        setCurrentPatient(newPatient);
      };

      const addReport = (r) => {
        saveReport(r);
        setReports([...reports, r]);
      };

      if (!user) {
        return (
          <div className="h-screen flex items-center justify-center bg-gray-200">
            <div className="bg-white p-6 rounded shadow w-96">
              <h1 className="text-xl font-bold mb-4">Lab Login</h1>
              <LoginForm onLogin={handleLogin} />
            </div>
          </div>
        );
      }

      return (
        <div className="p-4">
          <h1 className="text-2xl font-bold mb-4">AlphaMed Clinical Laboratory</h1>
          <div className="flex space-x-4">
            <div className="w-1/2">
              <PatientForm onSave={addPatient} />
              {currentPatient && <ReportForm patient={currentPatient} onSave={addReport} />}
            </div>
            <div className="w-1/2">
              <ReportsList reports={reports} />
            </div>
          </div>
        </div>
      );
    }

    // --- LoginForm ---
    function LoginForm({ onLogin }) {
      const [u, setU] = React.useState("");
      const [p, setP] = React.useState("");
      return (
        <div>
          <input className="border p-2 w-full mb-2" placeholder="Username" value={u} onChange={e => setU(e.target.value)} />
          <input className="border p-2 w-full mb-2" placeholder="Password" type="password" value={p} onChange={e => setP(e.target.value)} />
          <button className="bg-primary text-white px-4 py-2 w-full" onClick={() => onLogin(u, p)}>Login</button>
        </div>
      );
    }

    // --- PatientForm ---
    function PatientForm({ onSave }) {
      const [name, setName] = React.useState("");
      const [age, setAge] = React.useState("");
      const [gender, setGender] = React.useState("Male");
      return (
        <div className="bg-white p-4 rounded shadow mb-4">
          <h2 className="font-bold mb-2">New Patient</h2>
          <input className="border p-2 w-full mb-2" placeholder="Name" value={name} onChange={e=>setName(e.target.value)} />
          <input className="border p-2 w-full mb-2" placeholder="Age" value={age} onChange={e=>setAge(e.target.value)} />
          <select className="border p-2 w-full mb-2" value={gender} onChange={e=>setGender(e.target.value)}>
            <option>Male</option>
            <option>Female</option>
          </select>
          <button className="bg-secondary text-white px-4 py-2" onClick={() => {
            if(name && age) {
              onSave({ name, age, gender });
              setName(""); setAge("");
            }
          }}>Save Patient</button>
        </div>
      );
    }

    // --- ReportForm ---
    function ReportForm({ patient, onSave }) {
      const [dept, setDept] = React.useState(departments[0].name);
      const [test, setTest] = React.useState(departments[0].tests[0].name);
      const [values, setValues] = React.useState({});
      const department = departments.find(d => d.name === dept);
      const selectedTest = department.tests.find(t => t.name === test);

      return (
        <div className="bg-white p-4 rounded shadow mb-4">
          <h2 className="font-bold mb-2">New Report for {patient.name}</h2>
          <select className="border p-2 w-full mb-2" value={dept} onChange={e=>setDept(e.target.value)}>
            {departments.map(d => <option key={d.name}>{d.name}</option>)}
          </select>
          <select className="border p-2 w-full mb-2" value={test} onChange={e=>setTest(e.target.value)}>
            {department.tests.map(t => <option key={t.name}>{t.name}</option>)}
          </select>
          {selectedTest.params.map((p,i) => (
            <div key={p} className="flex items-center mb-2">
              <label className="w-1/3">{p}</label>
              <input className="border p-2 flex-1" value={values[p]||""} onChange={e=>setValues({...values,[p]:e.target.value})} />
              <span className="ml-2 text-sm text-gray-500">{selectedTest.ranges[i]}</span>
            </div>
          ))}
          <button className="bg-green-600 text-white px-4 py-2" onClick={()=>{
            const report = { patient, dept, test, values, date: new Date().toLocaleString() };
            onSave(report);
            alert("Report Saved!");
          }}>Save Report</button>
        </div>
      );
    }

    // --- ReportsList ---
    function ReportsList({ reports }) {
      return (
        <div className="bg-white p-4 rounded shadow h-full overflow-y-auto">
          <h2 className="font-bold mb-2">Reports</h2>
          {reports.map((r,i)=>(
            <div key={i} className="border-b py-2">
              <p><b>{r.patient.name}</b> - {r.test} ({r.dept})</p>
              <p className="text-sm text-gray-500">{r.date}</p>
            </div>
          ))}
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>
</html>
