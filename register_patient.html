<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register New Patient â€” Prime Medical Lab</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logo.png" />
  <style>
    .container {
      max-width: 700px;
      margin: 30px auto;
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 10px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .actions {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>Register New Patient</h2>
      <div>
        <button class="btn btn-small" onclick="window.location.href='reception.html'">Back</button>
        <button class="btn btn-small btn-outline" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="container">
    <form id="patientForm">
      <label>Patient Name</label>
      <input type="text" id="name" required placeholder="Enter full name" />

      <label>Age</label>
      <input type="number" id="age" required min="1" max="120" placeholder="Enter age" />

      <label>Gender</label>
      <select id="gender" required>
        <option value="">Select</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>

      <label>Test Name</label>
      <select id="testName" required>
        <option value="">Select Test</option>
      </select>

      <label>Assign Technician</label>
      <select id="technician" required>
        <option value="">Select Technician</option>
      </select>

      <div class="actions">
        <button type="submit" class="btn">Register Patient</button>
      </div>
    </form>
  </div>

  <script src="storage.js"></script>
  <script src="test-data.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const user = getLoggedInUser();
      if (!user || user.role !== "reception") {
        alert("Access denied! Reception staff only.");
        window.location.href = "login.html";
        return;
      }

      const testSelect = document.getElementById("testName");
      const techSelect = document.getElementById("technician");
      const tests = getAllTestsData();
      const technicians = getAllUsers().filter(u => u.role === "technician");

      tests.forEach(test => {
        const option = document.createElement("option");
        option.value = test.name;
        option.textContent = `${test.name} (${test.category})`;
        testSelect.appendChild(option);
      });

      technicians.forEach(tech => {
        const option = document.createElement("option");
        option.value = tech.username;
        option.textContent = tech.fullName;
        techSelect.appendChild(option);
      });

      document.getElementById("patientForm").addEventListener("submit", e => {
        e.preventDefault();
        registerPatient();
      });
    });

    function registerPatient() {
      const name = document.getElementById("name").value.trim();
      const age = parseInt(document.getElementById("age").value);
      const gender = document.getElementById("gender").value;
      const testName = document.getElementById("testName").value;
      const technician = document.getElementById("technician").value;

      if (!name || !age || !gender || !testName || !technician) {
        alert("Please fill all required fields.");
        return;
      }

      const patient = {
        id: "P" + Date.now(),
        name,
        age,
        gender,
        testName,
        technician,
        testStatus: "Pending",
        date: new Date().toLocaleDateString()
      };

      savePatient(patient);
      alert("Patient registered successfully!");
      window.location.href = "reception.html";
    }
  </script>
</body>
</html>
