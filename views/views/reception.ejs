<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reception - Alpha Med Lab</title>
  <link rel="stylesheet" href="/public/css/style.css">
  <script>
    async function loadTests() {
      const dept = document.getElementById('dept').value;
      if(!dept) return;
      const res = await fetch('/api/tests/by-dept/' + dept);
      const data = await res.json();
      const list = document.getElementById('tests-list');
      list.innerHTML = '';
      data.forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="checkbox" name="tests" value="${t.id}"> ${t.test_name} (${t.parameter}) [${t.normal_min}-${t.normal_max} ${t.unit}]</label>`;
        list.appendChild(li);
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>Reception</h1>
    <p>Welcome, <%= user.username %> | <a href="/logout">Logout</a></p>

    <section>
      <h2>Register Patient</h2>
      <form method="post" action="/patients">
        <input name="name" placeholder="Full name" required>
        <input name="dob" placeholder="YYYY-MM-DD">
        <input name="phone" placeholder="Phone">
        <button type="submit">Add Patient</button>
      </form>
    </section>

    <section>
      <h2>Order Tests</h2>
      <form method="post" action="/order-tests" onsubmit="return confirm('Place test order?')">
        <label>Patient</label>
        <select name="patient_id" required>
          <% patients.forEach(p=>{ %>
            <option value="<%= p.id %>"><%= p.name %> (#<%= p.patient_code %>)</option>
          <% }) %>
        </select>

        <label>Department</label>
        <select id="dept" onchange="loadTests()">
          <option value="">--select--</option>
          <% departments.forEach(d=>{ %>
            <option value="<%= d.id %>"><%= d.name %></option>
          <% }) %>
        </select>

        <ul id="tests-list" style="max-height:250px;overflow:auto;list-style:none;padding-left:0"></ul>
        <button type="submit">Place Order</button>
      </form>
    </section>

    <section>
      <h2>Recent Patients</h2>
      <ul>
        <% patients.forEach(p=>{ %>
          <li><%= p.name %> - code: <%= p.patient_code %> - <a href="/patient/<%= p.patient_code %>" target="_blank">view reports</a></li>
        <% }) %>
      </ul>
    </section>

  </div>
</body>
</html>
