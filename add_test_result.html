<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Test Result — Prime Medical Lab</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="logo.png" />
</head>
<body>
  <!-- Header -->
  <header class="topbar">
    <div class="container">
      <div class="brand">
        <img src="logo.png" alt="Lab Logo" class="logo" />
        <h1>Add Test Result</h1>
      </div>
      <nav class="main-nav">
        <a href="technician_dashboard.html">Dashboard</a>
        <a href="add_test_result.html" class="active">Add Result</a>
        <a href="view_reports.html">Reports</a>
        <button onclick="logout()" class="btn-logout">Logout</button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="container main-content">
    <section>
      <h2>Pending Test List</h2>
      <table class="data-table" id="pendingTestsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Patient Name</th>
            <th>Test Type</th>
            <th>Registered</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="resultSection" style="display:none; margin-top:40px;">
      <h2>Enter Test Result</h2>
      <form id="resultForm" class="form-grid">
        <input type="hidden" id="patientId" />
        <div class="form-group">
          <label>Patient Name</label>
          <input type="text" id="patientName" readonly />
        </div>
        <div class="form-group">
          <label>Test Type</label>
          <input type="text" id="testType" readonly />
        </div>
        <div class="form-group">
          <label>Result Details</label>
          <textarea id="testResult" rows="5" required placeholder="Enter detailed result here..."></textarea>
        </div>
        <div class="form-group">
          <label>Remarks</label>
          <textarea id="remarks" rows="3" placeholder="Remarks (optional)"></textarea>
        </div>
        <button type="submit" class="btn">Save Result</button>
      </form>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container footer-inner">
      <p>&copy; <span id="year"></span> Prime Medical Lab — Add Test Result</p>
    </div>
  </footer>

  <!-- JS -->
  <script src="storage.js"></script>
  <script src="script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      showCurrentUserInfo();
      loadPendingTests();

      const resultForm = document.getElementById("resultForm");
      resultForm.addEventListener("submit", e => {
        e.preventDefault();
        const id = document.getElementById("patientId").value;
        const resultData = {
          result: document.getElementById("testResult").value.trim(),
          remarks: document.getElementById("remarks").value.trim(),
          completedAt: new Date().toLocaleString(),
          technician: getCurrentUser()?.username || "Unknown"
        };
        saveTestResult(id, resultData);
        alert("Test result saved successfully!");
        document.getElementById("resultSection").style.display = "none";
        loadPendingTests();
      });
    });

    function loadPendingTests() {
      const patients = getPatients();
      const tbody = document.querySelector("#pendingTestsTable tbody");
      tbody.innerHTML = "";

      patients
        .filter(p => !p.result)
        .forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.testType}</td>
            <td>${p.registeredAt}</td>
            <td><button class="btn-small" onclick="openResultForm('${p.id}')">Add Result</button></td>
          `;
          tbody.appendChild(tr);
        });
    }

    function openResultForm(id) {
      const patient = getPatients().find(p => p.id == id);
      if (!patient) return alert("Patient not found.");

      document.getElementById("resultSection").style.display = "block";
      document.getElementById("patientId").value = patient.id;
      document.getElementById("patientName").value = patient.name;
      document.getElementById("testType").value = patient.testType;
      document.getElementById("testResult").value = "";
      document.getElementById("remarks").value = "";
      window.scrollTo({ top: document.getElementById("resultSection").offsetTop, behavior: "smooth" });
    }
  </script>
</body>
</html>
